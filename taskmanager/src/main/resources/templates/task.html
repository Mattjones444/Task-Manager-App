<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Board</title>

  <link rel="stylesheet" href="/task.css" />
  <style>
    #deleteZone {
      border: 2px dashed #d9534f;
      color: #d9534f;
      padding: 1rem;
      text-align: center;
      border-radius: .5rem;
      margin-top: 1.5rem;
    }
    #deleteZone.drag-over {
      background: #fdecea;
    }
  </style>
</head>
<body>

  <button class="task" id="openTaskModalBtn">Create Task</button>

  <div class="board">
    <div class="column">
      <h2>To Do</h2>
      <ul>
        <li class="task-card" draggable="true"
            th:each="task : ${todoTasks}"
            th:attr="data-task-id=${task.id}">
          <strong th:text="${task.title}">Sample To Do Task</strong><br/>
          <small th:text="'Due: ' + ${task.setDate}">Due: 2025-06-17</small>
        </li>
      </ul>
    </div>

    <div class="column">
      <h2>In Progress</h2>
      <ul>
        <li class="task-card" draggable="true"
            th:each="task : ${inProgressTasks}"
            th:attr="data-task-id=${task.id}">
          <strong th:text="${task.title}">Sample Inâ€‘Progress Task</strong><br/>
          <small th:text="'Due: ' + ${task.setDate}">Due: 2025-06-17</small>
        </li>
      </ul>
    </div>

    <div class="column">
      <h2>Done</h2>
      <ul>
        <li class="task-card" draggable="true"
            th:each="task : ${doneTasks}"
            th:attr="data-task-id=${task.id}">
          <strong th:text="${task.title}">Sample Done Task</strong><br/>
          <small th:text="'Due: ' + ${task.setDate}">Due: 2025-06-17</small>
        </li>
      </ul>
    </div>
  </div>

  <div id="deleteZone"><strong>ðŸ—‘Â Drag here to delete</strong></div>

  <div id="taskModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Create New Task</h2>
      <form id="taskForm" th:action="@{/api/tasks}" method="post" th:object="${newTask}" onsubmit="submitTaskForm(event)">
        <div class="form-group">
          <label for="taskTitle">Task Title:</label>
          <input type="text" id="taskTitle" name="title" required />
        </div>
        <div class="form-group">
          <label for="taskDescription">Description:</label>
          <textarea id="taskDescription" name="description" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label for="taskDueDate">Schedule Completion Date:</label>
          <input type="date" id="taskDueDate" name="setDate" />
        </div>
        <button type="submit" class="task">Add Task</button>
      </form>
    </div>
  </div>

<script>
const tasks = document.querySelectorAll('.task-card');
tasks.forEach(t => { t.setAttribute('draggable', true); t.addEventListener('dragstart', dragStart); });

function dragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
  e.dataTransfer.effectAllowed = 'move';
}

function dragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function drop(e) {
  e.preventDefault();
  const taskId = e.dataTransfer.getData('text/plain');
  if (!taskId) return;

  const column = e.target.closest('.column');
  if (!column) return;

  const columnTitle = column.querySelector('h2').innerText.trim();
  const statusMap = { 'To Do':'TO_DO', 'In Progress':'IN_PROGRESS', 'Done':'DONE' };
  const newStatus = statusMap[columnTitle];

  fetch(`/api/tasks/${taskId}`, {
    method:'PATCH',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ status:newStatus })
  }).then(r=>{ if(!r.ok) throw Error(); })
    .then(()=>{
      const dropZone = column.querySelector('ul');
      const card     = document.querySelector(`.task-card[data-task-id='${taskId}']`);
      if (card && dropZone) dropZone.appendChild(card);
    }).catch(()=>alert('Failed to update task status'));
}

document.querySelectorAll('.column ul').forEach(ul=>{
  ul.addEventListener('dragover', dragOver);
  ul.addEventListener('drop',     drop);
});

const deleteZone = document.getElementById('deleteZone');
deleteZone.addEventListener('dragover',  e => { e.preventDefault(); deleteZone.classList.add('drag-over'); });
deleteZone.addEventListener('dragleave', () => deleteZone.classList.remove('drag-over'));
deleteZone.addEventListener('drop',      deleteDrop);

function deleteDrop(e) {
  e.preventDefault();
  deleteZone.classList.remove('drag-over');
  const taskId = e.dataTransfer.getData('text/plain');
  if (!taskId) return;
  if (!confirm('Delete this task?')) return;

  fetch(`/api/tasks/${taskId}`, { method:'DELETE' })
    .then(r => {
      if (r.ok) {
        const card = document.querySelector(`.task-card[data-task-id='${taskId}']`);
        if (card) card.remove();
      } else {
        alert('Failed to delete task');
      }
    })
    .catch(()=>alert('Failed to delete task'));
}

const modal          = document.getElementById('taskModal');
const openModalBtn   = document.getElementById('openTaskModalBtn');
const closeModalBtn  = modal.querySelector('.close-button');
const taskForm       = document.getElementById('taskForm');

openModalBtn.onclick = ()=> modal.style.display='flex';
closeModalBtn.onclick= ()=> modal.style.display='none';
window.onclick       = e => { if(e.target===modal) modal.style.display='none'; };

function submitTaskForm(e){
  e.preventDefault();
  const formData = { title:taskForm.title.value, description:taskForm.description.value,
                     setDate:taskForm.setDate.value, status:'TO_DO' };

  fetch('/api/tasks', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(formData)})
    .then(r=>{ if(!r.ok) throw Error(); return r.json(); })
    .then(newTask=>{
      modal.style.display='none';
      taskForm.reset();

      const li = document.createElement('li');
      li.className='task-card';
      li.setAttribute('draggable','true');
      li.dataset.taskId = newTask.id;
      li.innerHTML = `<strong>${newTask.title}</strong><br/><small>Due: ${newTask.setDate || 'N/A'}</small>`;
      li.addEventListener('dragstart', dragStart);

      document.querySelector('.column:nth-child(1) ul').appendChild(li);
    })
    .catch(()=>alert('Failed to create task'));
}
</script>
</body>
</html>


